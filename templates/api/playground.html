{% extends 'base.html' %}
{% block title %}API Playground{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="mb-4">
    <h1 class="h3">Authloc API Playground</h1>
    <p class="text-muted">Use this lightweight console to issue requests against the Authloc API using your JWT token.</p>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <form id="api-form">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label for="method" class="form-label">Method</label>
            <select class="form-select" id="method">
              <option>GET</option>
              <option>POST</option>
              <option>PUT</option>
              <option>PATCH</option>
              <option>DELETE</option>
            </select>
          </div>
          <div class="col-md-9">
            <label for="endpoint" class="form-label">Endpoint</label>
            <div class="input-group">
              <span class="input-group-text">{{ request.scheme }}://{{ request.get_host }}</span>
              <input type="text" class="form-control" id="endpoint" placeholder="/api/v1/search/locations/" required>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-6">
            <label for="token" class="form-label">JWT Access Token</label>
            <input type="text" class="form-control" id="token" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            <div class="form-text">Acquire a token via the authentication endpoints. Sent as <code>Authorization: Bearer &lt;token&gt;</code>.</div>
          </div>
          <div class="col-md-6">
            <label for="headers" class="form-label">Headers (JSON)</label>
            <textarea class="form-control" id="headers" rows="3" placeholder='{ "Content-Type": "application/json" }'></textarea>
          </div>
        </div>

        <div class="mt-3">
          <label for="payload" class="form-label">Request Body (JSON)</label>
          <textarea class="form-control" id="payload" rows="6" placeholder='{"query": "central"}'></textarea>
        </div>

        <div class="mt-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary">Send Request</button>
          <a class="btn btn-outline-secondary" href="{{ swagger_url }}" target="_blank">Open Swagger UI</a>
          <a class="btn btn-outline-secondary" href="{{ schema_url }}" target="_blank">Download Schema</a>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">Response</div>
        <div class="card-body">
          <pre class="small" id="response-output">Awaiting request...</pre>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">Request Details</div>
        <div class="card-body">
          <pre class="small" id="request-preview">Fill the form to preview the request.</pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const form = document.getElementById('api-form');
  const responseOutput = document.getElementById('response-output');
  const requestPreview = document.getElementById('request-preview');

  function safeJSONParse(text, fallback) {
    if (!text) { return fallback; }
    try { return JSON.parse(text); }
    catch (err) { return fallback; }
  }

  function updatePreview() {
    const method = document.getElementById('method').value;
    const endpoint = document.getElementById('endpoint').value;
    const token = document.getElementById('token').value;
    const headers = safeJSONParse(document.getElementById('headers').value, {});
    const payload = document.getElementById('payload').value;

    const previewHeaders = Object.assign({}, headers);
    if (token) {
      previewHeaders['Authorization'] = `Bearer ${token}`;
    }

    const preview = {
      method,
      url: `${window.location.origin}${endpoint}`,
      headers: previewHeaders,
      body: payload ? safeJSONParse(payload, payload) : undefined,
    };

    requestPreview.textContent = JSON.stringify(preview, null, 2);
  }

  ['method', 'endpoint', 'token', 'headers', 'payload'].forEach(id => {
    document.getElementById(id).addEventListener('input', updatePreview);
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    updatePreview();

    const method = document.getElementById('method').value;
    const endpoint = document.getElementById('endpoint').value;
    const token = document.getElementById('token').value;
    const headers = safeJSONParse(document.getElementById('headers').value, {});
    const payloadText = document.getElementById('payload').value.trim();
    const url = `${window.location.origin}${endpoint}`;

    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    let body;
    if (payloadText) {
      try {
        body = JSON.stringify(JSON.parse(payloadText));
      } catch (err) {
        responseOutput.textContent = `Invalid JSON payload: ${err.message}`;
        return;
      }
    }

    responseOutput.textContent = 'Sending request...';

    try {
      const response = await fetch(url, {
        method,
        headers,
        body: ['GET', 'DELETE'].includes(method) ? undefined : body,
      });
      const text = await response.text();
      let parsed;
      try {
        parsed = JSON.parse(text);
      } catch (err) {
        parsed = text;
      }
      responseOutput.textContent = JSON.stringify({
        status: response.status,
        statusText: response.statusText,
        headers: Object.fromEntries(response.headers.entries()),
        data: parsed,
      }, null, 2);
    } catch (err) {
      responseOutput.textContent = `Request failed: ${err.message}`;
    }
  });

  updatePreview();
</script>
{% endblock %}
